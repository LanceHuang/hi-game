> 网络层：以前web是一次请求，一次返回，服务器不会主动向浏览器推送数据。游戏项目一般都是长连接，服务器可以随时向玩家推送消息，广播、交易申请什么的。

### 项目结构
```
ClientA -----------> +------------+         +------------+
                     |            | ------> |            | ----> XXController  
ClientB -----------> |   net      |         | dispatcher |
                     |            |         +------------+
ClientC -----------> +------------+ <--------------------------- AnyWhere
```
* net：只接收和响应消息，其中消息解析有专门的handler
* dispatcher：按玩家账号取模，可以保证玩家操作的并发安全；按地图块id取模，可以保证地图块内并发安全
* XXController：类似于SpringMVC的Controller
* AnyWhere：提供一个工具类，可以从任何地方回传消息（活动Handler、广播Service、业务Service）

### 设计思路
1. 连接时，用Session记录连接信息
2. 玩家登录时，将玩家信息记录到Session上
3. 响应时，获取Session，并响应请求
4. 请求/响应都用“消息”，消息属于实体类，有消息号

**第一阶段**：用Session存储信息，并存储至Context，每次读写都从Session中获取Socket/SocketChannel  

### 消息定义
* 服务端需要支持抽象成员变量，如：Map，AbstractItem
* 客户端可以根据传输的消息id，运行时选择不同的类型读取
* 需要统一的协议，以便生成前后端代码
```
length id body
```

### 需要解决的问题
1. 如何关闭服务器？要保证能完成当前读写的内容，要能将缓存数据都回写到数据库